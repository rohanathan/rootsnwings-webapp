<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Architecture: Roots & Wings Platform</title>
    <!-- Chosen Palette: Warm Neutral Harmony -->
    <!-- Application Structure Plan: Based on user feedback, the application has been redesigned into a single-page, single-purpose view. The entire focus is now on a detailed, clear, and robust architecture diagram that explains the end-to-end data flow. All other sections have been removed. The structure consists of the diagram itself, followed by togglable text descriptions for two key scenarios (Secure and Public flows). This design prioritizes clarity, reliability, and directness over complex navigation, directly addressing the need for a high-quality architectural visualization. -->
    <!-- Visualization & Content Choices: The core visualization is a single, comprehensive architecture diagram built entirely with HTML divs and styled with Tailwind CSS to ensure maximum reliability and avoid the rendering issues of the previous SVG-based approach. The diagram is annotated with numbered steps. Below the diagram, two sets of detailed text explanations correspond to these numbers. Buttons allow the user to toggle between the "Secure Flow" and "Public Flow" explanations. This interactive method was chosen to clearly explain different paths through the same core architecture without cluttering the UI. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
        }
        .flow-description {
            display: none;
        }
        .flow-description.active {
            display: block;
        }
        .flow-button.active {
            background-color: #4A90E2;
            color: white;
        }
        .diagram-connector {
            position: absolute;
            background-color: #CBD5E1;
            z-index: -1;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4 md:p-8">

    <main class="w-full max-w-7xl bg-white rounded-2xl shadow-2xl p-6 md:p-12">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-[#3B3B3B]">Roots & Wings System Architecture</h1>
            <p class="text-lg text-gray-600 mt-4 max-w-3xl mx-auto">A detailed look at the request and response flow, from the user's browser to the database and back.</p>
        </div>

        <!-- Architecture Diagram -->
        <div class="relative w-full h-[600px] mb-12">
            <!-- Connectors -->
            <div class="diagram-connector" style="left: 18%; top: 50%; width: 12%; height: 2px;"></div>
            <div class="diagram-connector" style="left: 30%; top: 25%; width: 2px; height: 50%;"></div>
            <div class="diagram-connector" style="left: 30%; top: 25%; width: 15%; height: 2px;"></div>
            <div class="diagram-connector" style="left: 30%; top: 75%; width: 15%; height: 2px;"></div>
            <div class="diagram-connector" style="left: 45%; top: 25%; width: 2px; height: 50%;"></div>
            <div class="diagram-connector" style="left: 45%; top: 25%; width: 35%; height: 2px;"></div>
            <div class="diagram-connector" style="left: 45%; top: 75%; width: 35%; height: 2px;"></div>
            <div class="diagram-connector" style="left: 80%; top: 25%; width: 2px; height: 50%;"></div>

            <!-- Nodes -->
            <div id="node-user" class="absolute flex flex-col items-center text-center" style="left: 5%; top: 50%; transform: translateY(-50%);">
                <div class="w-32 h-32 bg-blue-100 border-2 border-blue-300 rounded-full flex items-center justify-center p-2 shadow-lg">
                    <span class="font-bold text-blue-800">User's Browser</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Next.js Frontend</p>
            </div>

            <div id="node-cloudrun" class="absolute flex flex-col items-center text-center" style="left: 50%; top: 25%; transform: translate(-50%, -50%);">
                <div class="w-32 h-32 bg-green-100 border-2 border-green-300 rounded-lg flex items-center justify-center p-2 shadow-lg">
                    <span class="font-bold text-green-800">FastAPI on Cloud Run</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Backend Logic</p>
            </div>

            <div id="node-auth" class="absolute flex flex-col items-center text-center" style="left: 50%; top: 75%; transform: translate(-50%, -50%);">
                <div class="w-32 h-32 bg-red-100 border-2 border-red-300 rounded-lg flex items-center justify-center p-2 shadow-lg">
                    <span class="font-bold text-red-800">Firebase Auth</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Identity Service</p>
            </div>
            
            <div id="node-firestore" class="absolute flex flex-col items-center text-center" style="left: 95%; top: 25%; transform: translate(-50%, -50%);">
                <div class="w-32 h-32 bg-yellow-100 border-2 border-yellow-300 rounded-lg flex items-center justify-center p-2 shadow-lg">
                    <span class="font-bold text-yellow-800">Firestore DB</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Application Data</p>
            </div>

            <div id="node-storage" class="absolute flex flex-col items-center text-center" style="left: 95%; top: 75%; transform: translate(-50%, -50%);">
                <div class="w-32 h-32 bg-purple-100 border-2 border-purple-300 rounded-lg flex items-center justify-center p-2 shadow-lg">
                    <span class="font-bold text-purple-800">Cloud Storage</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">File Storage</p>
            </div>

            <!-- Flow Numbers -->
            <span class="absolute font-bold text-lg text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center" style="left: 28%; top: 74%;">1</span>
            <span class="absolute font-bold text-lg text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center" style="left: 28%; top: 24%;">2</span>
            <span class="absolute font-bold text-lg text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center" style="left: 43%; top: 49%;">3</span>
            <span class="absolute font-bold text-lg text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center" style="left: 78%; top: 24%;">4</span>
            <span class="absolute font-bold text-lg text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center" style="left: 78%; top: 49%;">5</span>
        </div>

        <!-- Flow Descriptions -->
        <div>
            <div class="flex justify-center items-center border border-gray-200 rounded-lg p-1 max-w-md mx-auto mb-8">
                <button id="show-secure-flow" class="flow-button w-1/2 p-3 font-semibold rounded-md transition-colors active">Secure Request Flow</button>
                <button id="show-public-flow" class="flow-button w-1/2 p-3 font-semibold rounded-md transition-colors">Public Request Flow</button>
            </div>

            <div id="secure-flow" class="flow-description active">
                <h3 class="text-2xl font-bold text-center mb-6">Secure Flow: Viewing a Private Profile</h3>
                <ol class="list-decimal list-inside space-y-4 max-w-3xl mx-auto text-gray-700">
                    <li><span class="font-bold">User Authentication:</span> The user logs in on the Next.js frontend. The app communicates directly with **Firebase Auth**, which verifies the user's credentials and returns a secure JWT ID Token to the browser.</li>
                    <li><span class="font-bold">API Request with Token:</span> To fetch private data, the frontend sends a request to the **FastAPI backend** (e.g., `GET /api/profile/me`). This request includes the JWT ID Token in its `Authorization` header.</li>
                    <li><span class="font-bold">Backend Token Verification:</span> The FastAPI backend receives the request. Before processing, it sends the token to **Firebase Auth** for verification. Firebase Auth confirms the token is valid and returns the user's decoded information, including their unique UID.</li>
                    <li><span class="font-bold">Database Query:</span> Now trusting the user's identity, the backend uses the UID to query the **Firestore Database** for the specific user's private profile document.</li>
                    <li><span class="font-bold">Response to Client:</span> Firestore returns the data to the backend. FastAPI formats it as a JSON response and sends it back to the user's browser, which then displays the profile.</li>
                </ol>
            </div>

            <div id="public-flow" class="flow-description">
                <h3 class="text-2xl font-bold text-center mb-6">Public Flow: Searching for Classes</h3>
                <ol class="list-decimal list-inside space-y-4 max-w-3xl mx-auto text-gray-700">
                    <li><span class="font-bold">User Action:</span> A user (who may or may not be logged in) performs a search for classes on the Next.js frontend.</li>
                    <li><span class="font-bold">Public API Request:</span> The frontend sends a request to a public endpoint on the **FastAPI backend** (e.g., `GET /api/classes?category=Art`). No authentication token is required for this request.</li>
                    <li><span class="font-bold">Backend Logic Execution:</span> The FastAPI backend receives the request and immediately proceeds to its business logic, as no token verification is needed for this public route.</li>
                    <li><span class="font-bold">Database Query:</span> The backend queries the **Firestore Database** based on the public search criteria (e.g., find all documents in the `classes` collection where the category is 'Art').</li>
                    <li><span class="font-bold">Response to Client:</span> Firestore returns the list of matching classes. The backend formats this list into a JSON response and sends it back to the user's browser, which then displays the search results.</li>
                </ol>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const secureBtn = document.getElementById('show-secure-flow');
            const publicBtn = document.getElementById('show-public-flow');
            const secureFlowDesc = document.getElementById('secure-flow');
            const publicFlowDesc = document.getElementById('public-flow');

            secureBtn.addEventListener('click', () => {
                secureBtn.classList.add('active');
                publicBtn.classList.remove('active');
                secureFlowDesc.classList.add('active');
                publicFlowDesc.classList.remove('active');
            });

            publicBtn.addEventListener('click', () => {
                publicBtn.classList.add('active');
                secureBtn.classList.remove('active');
                publicFlowDesc.classList.add('active');
                secureFlowDesc.classList.remove('active');
            });
        });
    </script>
</body>
</html>
